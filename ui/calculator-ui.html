<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Happy Doc</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
</head>

<body>
<style>
    .hide {
        position: absolute;
        top: -1px;
        left: -1px;
        width: 1px;
        height: 1px;
    }
</style>

<iframe class="hide" name="hiddenFrame"></iframe>

<form onreset="resetEstimation()" onsubmit="calculate()" target="hiddenFrame">
    <div>
        <label>
            <input checked name="sex" type="radio" value="m"/>
            <span>Мальчик</span>
        </label>
        <label>
            <input name="sex" type="radio" value="f"/>
            <span>Девочка</span>
        </label>
    </div>
    <div class="row">
        <div class="input-field col s12">
            <input class="validate" id="age" max="17" min="3" required type="number">
            <label for="age">Возраст</label>
        </div>
    </div>
    <div class="row">
        <div class="input-field col s6">
            <input class="validate" id="height" max="220" min="30" required step="0.1" type="number">
            <label for="height">Рост</label>
        </div>
        <div class="input-field col s6">
            <input disabled id="heightCentile" tabIndex="-1" type="text" value="Центиль">
            <label for="height"></label>
        </div>
    </div>
    <div class="row">
        <div class="input-field col s6">
            <input class="validate" id="weight" max="150" min="1" required step="0.1" type="number">
            <label for="weight">Вес</label>
        </div>
        <div class="input-field col s6">
            <input disabled id="weightCentile" tabIndex="-1" type="text" value="Центиль">
            <label for="weight"></label>
        </div>
    </div>
    <div class="row">
        <div class="input-field col s6">
            <input class="validate" id="chest" max="150" min="25" required step="0.1" type="number">
            <label for="chest">Окружность груди</label>
        </div>
        <div class="input-field col s6">
            <input disabled id="chestCentile" tabIndex="-1" type="text" value="Центиль">
            <label for="chest"></label>
        </div>
    </div>
    <div class="row">
        <button class="waves-effect waves-light btn" type="submit">Рассчитать</button>
        <button class="waves-effect waves-light btn" type="reset">Очистить</button>
    </div>
    <div class="row">
        <p class="flow-text" id="result"></p>
    </div>
</form>

<script type="text/javascript">
    var webAppUrl = 'https://script.google.com/macros/s/AKfycby4FctT7k_pAaxEjRcZroAO-T13tJIt4naryF_UErpeCno5Clg/exec';

    function calculate() {
        var requestParams = getRequsetParams();
        if (requestParams) {
            var theUrl = webAppUrl + requestParams;
            httpGetAsync(theUrl, setResult)
        }
    }

    function setResult(responseText) {
        var estimation = JSON.parse(responseText);

        var somatype = "Соматип по сумме центилей: " + estimation.result.estimationBySum;

        if (estimation.result.estimationByCentilesDifference.estimation) {
            var centileDiffText = "Развитие по разнице центилей: " + estimation.result.estimationByCentilesDifference.estimation;
        }

        var detailsText;

        if (estimation.result.estimationByCentilesDifference.details) {
            var details = estimation.result.estimationByCentilesDifference.details;
            detailsText = "";
            if (details.height) {
                detailsText += " рост " + details.height + "<br>"
            }
            if (details.weight) {
                detailsText += " вес " + details.weight + "<br>"
            }
            if (details.chest) {
                detailsText += " окружность груди " + details.chest
            }
        }

        var estimationText = somatype;
        if (centileDiffText) {
            estimationText += "<br>" + centileDiffText;
        }
        if (detailsText) {
            estimationText += "<br>" + detailsText;
        }
        $('#result').html(estimationText);

        $('#heightCentile').val(estimation.centiles.height);
        $('#weightCentile').val(estimation.centiles.weight);
        $('#chestCentile').val(estimation.centiles.chest);
    }

    function getRequsetParams() {
        var sex = document.querySelector('input[name="sex"]:checked').value;
        var age = document.getElementById("age").value;
        var height = document.getElementById("height").value;
        var weight = document.getElementById("weight").value;
        var chest = document.getElementById("chest").value;

        if (age && height && weight && chest) {
            var requestParams = "?" +
                "sex=" + sex + "&" +
                "age=" + age + "&" +
                "height=" + height + "&" +
                "weight=" + weight + "&" +
                "chest=" + chest;
            return requestParams;
        } else {
            return false;
        }
    }

    function httpGetAsync(theUrl, callback) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.onreadystatechange = function () {
            if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
                callback(xmlHttp.responseText);
        };
        xmlHttp.open("GET", theUrl, true); // true for asynchronous
        xmlHttp.send(null);
    }

    function resetEstimation() {
        $('#result').html("");
    }
</script>
</body>
</html>